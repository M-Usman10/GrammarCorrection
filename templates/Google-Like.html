<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LLM Playground (Single Page)</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons (for mic, check, x, and volume icons) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <style>
      body {
        background-color: #fafafa;
        font-family: "Roboto", sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        color: #444;
      }
      .container {
        flex: 1;
        margin-top: 2rem;
        margin-bottom: 2rem;
      }
      footer {
        background-color: #f1f1f1;
        color: #666;
        text-align: center;
        padding: 1rem 0;
        margin-top: auto;
      }
      .usage-pre {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 0.75rem;
        border-radius: 4px;
        max-height: 300px;
        overflow: auto;
        font-family: monospace;
        white-space: pre;
      }
      .logs-box {
        background: #212121;
        color: #eee;
        border-radius: 4px;
        padding: 0.75rem;
        max-height: 600px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre;
      }
      .mic-btn {
        background-image: linear-gradient(
          to right,
          #4285f4,
          #ea4335,
          #fbbc05,
          #34a853
        );
        color: #fff;
        border: none;
      }
      .mic-btn i {
        font-size: 1.2rem;
      }
      .speaker-btn {
        background-color: #6c757d;
        color: #fff;
        border: none;
      }
      .recording-indicator {
        font-weight: bold;
        color: #d9534f;
      }
      .hidden {
        display: none !important;
      }
      .audio-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.5rem;
        background: #f1f3f4;
        padding: 15px 10px;
        border-radius: 30px;
      }
      .audio-controls button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
      }
      .form-range {
        appearance: none;
        width: 100%;
        height: 8px;
        background: #ddd;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
      }
      .form-range::-webkit-slider-runnable-track {
        background: black;
        height: 8px;
        border-radius: 4px;
      }
      .form-range::-webkit-range-progress {
        background: gray;
        height: 8px;
        border-radius: 4px;
      }
      .form-range::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        background: gray;
        border-radius: 50%;
        cursor: pointer;
      }
      .audio-controls span {
        white-space: nowrap;
        font-size: 0.9rem;
        width: 6rem;
        text-align: center;
      }
      .whisperAudio {
        margin-top: 15px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Navbar with Tabs -->
    <nav
      class="navbar navbar-expand-lg"
      style="
        background-image: linear-gradient(
          to right,
          #4285f4,
          #ea4335,
          #fbbc05,
          #34a853
        );
      "
    >
      <div class="container">
        <a class="navbar-brand text-white fw-bold" href="#">LLM Playground</a>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container">
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="home-tab"
            data-bs-toggle="tab"
            href="#home"
            role="tab"
            aria-controls="home"
            aria-selected="true"
            >Home</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="manage-tab"
            data-bs-toggle="tab"
            href="#manageModels"
            role="tab"
            aria-controls="manageModels"
            aria-selected="false"
            >Manage Models</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="audiocontrols-tab"
            data-bs-toggle="tab"
            href="#audioControls"
            role="tab"
            aria-controls="audioControls"
            aria-selected="false"
            >Audio Controls</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="server-tab"
            data-bs-toggle="tab"
            href="#serverControl"
            role="tab"
            aria-controls="serverControl"
            aria-selected="false"
            >Server Control</a
          >
        </li>
      </ul>

      <div class="tab-content" id="mainTabContent">
        <!-- HOME TAB (Inference) -->
        <div
          class="tab-pane fade show active"
          id="home"
          role="tabpanel"
          aria-labelledby="home-tab"
        >
          <div class="row justify-content-center g-4 mt-3">
            <div class="col-md-8">
              <div class="card border-0 shadow-sm">
                <!-- Updated card-header layout -->
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <!-- Left: "Current Activity ID" label (bold) and the ID -->
                    <div>
                      <span class="me-2 fw-bold">Current Activity ID:</span>
                      <span id="currentActivityLabel"></span>
                    </div>
                    <!-- Right: Activity controls (Enter ID, refresh, load, back/next) -->
                    <div class="d-flex align-items-center">
                      <input
                        type="text"
                        id="loadActivityInput"
                        class="form-control form-control-sm me-2"
                        placeholder="Enter Activity ID"
                        style="width: 150px;"
                      />
                      <!-- Icon button for refresh (no text) -->
                      <button
                        id="refreshActivityBtn"
                        class="btn btn-light btn-sm me-2"
                      >
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                      <button id="loadActivityBtn" class="btn btn-secondary btn-sm me-2">
                        Load
                      </button>
                      <button id="backBtn" class="btn btn-outline-secondary btn-sm me-2">
                        Back
                      </button>
                      <button id="nextBtn" class="btn btn-outline-secondary btn-sm">
                        Next
                      </button>
                    </div>
                  </div>
                </div>
                <!-- card-body -->
                <div class="card-body">
                  <!-- 1) Model Response: text -->
                  <div
                    id="response-container"
                    class="mb-3"
                    style="display: none"
                  >
                    <h6>Model Response</h6>
                    <div class="alert alert-secondary" id="response"></div>
                  </div>

                  <!-- 2) Model Response: audio -->
                  <div class="mb-3" id="responseAudioSection" style="display: none">
                    <button id="playResponseTTSBtn" class="btn speaker-btn">
                      <i class="bi bi-volume-up"></i> Generate Audio
                    </button>
                    <audio
                      id="responseAudio"
                      preload="metadata"
                      style="display: none"
                    ></audio>
                    <div
                      class="audio-controls"
                      id="responseAudioControls"
                      style="display: none"
                    >
                      <button
                        id="responsePlayPauseBtn"
                        class="border-0"
                      >
                        <i class="bi bi-play-fill"></i>
                      </button>
                      <span id="responseAudioTime">00:00 / 00:00</span>
                      <input
                        type="range"
                        min="0"
                        max="100"
                        step="1"
                        value="0"
                        id="responseAudioProgress"
                        class="form-range"
                      />
                    </div>
                  </div>

                  <!-- 3) Model Transcript: txt (Whisper transcription) -->
                  <div
                    id="whisper-container"
                    class="mb-3"
                    style="display: none"
                  >
                    <h6>Whisper Transcription</h6>
                    <textarea
                      class="form-control"
                      id="whisper-transcription-editable"
                      rows="3"
                    ></textarea>
                  </div>

                  <!-- 4) Model Transcript: audio (the TTS of the whisper text) -->
                  <div class="mb-3" id="whisperAudioSection" style="display: none">
                    <button id="playWhisperTTSBtn" class="btn speaker-btn">
                      <i class="bi bi-volume-up"></i> Generate Audio
                    </button>
                    <audio
                      id="whisperAudio"
                      class="hidden whisperAudio"
                      preload="metadata"
                    ></audio>
                    <div
                      class="audio-controls"
                      id="whisperAudioControls"
                      style="display: none"
                    >
                      <button id="whisperPlayPauseBtn" class="border-0">
                        <i class="bi bi-play-fill"></i>
                      </button>
                      <span id="whisperAudioTime">00:00 / 00:00</span>
                      <input
                        type="range"
                        min="0"
                        max="100"
                        step="1"
                        value="0"
                        id="whisperAudioProgress"
                        class="form-range"
                      />
                    </div>
                  </div>

                  <!-- 5) Submit for Inference (whisper) -->
                  <div class="mb-3" id="whisperInferenceSection" style="display: none">
                    <button
                      id="whisperInferenceBtn"
                      class="btn btn-primary w-100"
                    >
                      Submit Whisper Text for Inference
                    </button>
                  </div>

                  <!-- 6) Select model -->
                  <div class="mb-3">
                    <label for="model" class="form-label">Select Model</label>
                    <select
                      class="form-select"
                      id="model"
                      name="model"
                      required
                    >
                      <option value="" disabled selected>
                        Loading models...
                      </option>
                    </select>
                  </div>

                  <!-- 7) User query: txt -->
                  <div class="mb-3">
                    <label for="query" class="form-label">User Query</label>
                    <textarea
                      class="form-control"
                      id="query"
                      name="query"
                      rows="3"
                    ></textarea>
                  </div>

                  <!-- 8) Submit button (user query) -->
                  <div class="mb-3">
                    <button
                      class="btn btn-primary w-100"
                      id="submitQueryBtn"
                    >
                      Submit Query
                    </button>
                  </div>

                  <!-- 9) user input: audio (record button) -->
                  <div class="text-center">
                    <button id="startRecordingBtn" class="btn mic-btn">
                      <i class="bi bi-mic"></i> Record
                    </button>
                  </div>

                  <!-- Recording UI (hidden initially) -->
                  <div id="recordingUI" class="mt-4 hidden text-center">
                    <p
                      class="recording-indicator"
                      id="recordingIndicator"
                      style="display: none"
                    >
                      Recording...
                    </p>
                    <!-- Timer element -->
                    <p
                      id="record-timer"
                      style="font-size: 1.2rem; margin-bottom: 1rem"
                    >
                      00:00
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                      <button id="cancelRecordingBtn" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i>
                      </button>
                      <button id="confirmRecordingBtn" class="btn btn-success">
                        <i class="bi bi-check-lg"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Loader -->
                  <div
                    id="loader"
                    class="mt-3 text-center"
                    style="display: none"
                  >
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your request...</p>
                  </div>
                </div>
                <!-- /card-body -->
              </div>
            </div>
          </div>
        </div>
        <!-- end HOME TAB -->

        <!-- MANAGE MODELS TAB -->
        <div
          class="tab-pane fade"
          id="manageModels"
          role="tabpanel"
          aria-labelledby="manage-tab"
        >
          <div class="row justify-content-center g-4 mt-3">
            <div class="col-md-8">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white text-center">
                  <h5 class="mb-0">Manage Models</h5>
                </div>
                <div class="card-body">
                  <!-- Add Model -->
                  <div class="mb-4">
                    <button
                      class="btn btn-success"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseAddModel"
                    >
                      Add New Model
                    </button>
                    <div class="collapse mt-3" id="collapseAddModel">
                      <form id="add-model-form">
                        <div class="mb-3">
                          <label for="new_model_name" class="form-label"
                            >New Model Name</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="new_model_name"
                            name="new_model_name"
                            required
                          />
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                          Create Model
                        </button>
                      </form>
                      <div
                        id="add-model-result"
                        class="mt-3"
                        style="display: none"
                      >
                        <div
                          class="alert alert-success"
                          id="add-model-success"
                        ></div>
                        <pre
                          class="usage-pre mt-2"
                          id="usage-code"
                          style="display: none"
                        ></pre>
                      </div>
                    </div>
                  </div>

                  <!-- Delete Model -->
                  <div class="mb-4">
                    <button
                      class="btn btn-danger"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseDeleteModel"
                    >
                      Delete Model
                    </button>
                    <div class="collapse mt-3" id="collapseDeleteModel">
                      <form id="delete-model-form">
                        <div class="mb-3">
                          <label for="delete_model_name" class="form-label"
                            >Select Model Folder</label
                          >
                          <select
                            class="form-select"
                            id="delete_model_name"
                            name="delete_model_name"
                            required
                          >
                            <option value="" disabled selected>
                              Loading models...
                            </option>
                          </select>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">
                          Delete Model
                        </button>
                      </form>
                      <div
                        id="delete-model-result"
                        class="mt-3"
                        style="display: none"
                      >
                        <div
                          class="alert alert-success"
                          id="delete-model-success"
                        ></div>
                      </div>
                    </div>
                  </div>

                  <!-- Get Client Code for Existing Models -->
                  <div class="mb-4">
                    <button
                      class="btn btn-secondary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseGetClientCode"
                    >
                      Get Client Code
                    </button>
                    <div class="collapse mt-3" id="collapseGetClientCode">
                      <form id="get-code-form">
                        <div class="mb-3">
                          <label for="code_model_name" class="form-label"
                            >Select Model Folder</label
                          >
                          <select
                            class="form-select"
                            id="code_model_name"
                            name="folder_name"
                            required
                          >
                            <option value="" disabled selected>
                              Loading models...
                            </option>
                          </select>
                        </div>
                        <button type="submit" class="btn btn-info w-100">
                          Get Code
                        </button>
                      </form>
                      <div
                        id="get-code-result"
                        class="mt-3"
                        style="display: none"
                      >
                        <pre class="usage-pre" id="client-code-display"></pre>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- card-body -->
              </div>
            </div>
          </div>
        </div>
        <!-- end MANAGE MODELS TAB -->

        <!-- AUDIO CONTROLS TAB -->
        <div
          class="tab-pane fade"
          id="audioControls"
          role="tabpanel"
          aria-labelledby="audiocontrols-tab"
        >
          <div class="row justify-content-center g-4 mt-3">
            <div class="col-md-8">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white text-center">
                  <h5 class="mb-0">Audio Controls</h5>
                </div>
                <div class="card-body">
                  <!-- Whisper TTS controls -->
                  <h6 class="fw-bold">Whisper TTS Settings</h6>
                  <div class="mb-3">
                    <label for="whisperTtsSpeakerSelect" class="form-label"
                      >Voice</label
                    >
                    <select class="form-select" id="whisperTtsSpeakerSelect">
                      <!-- Female Voices -->
                      <optgroup label="Female Voices">
                        <option value="p240">Dawn</option>
                        <option value="p244">Ember</option>
                        <option value="p245">Willow</option>
                        <option value="p246">Rose</option>
                        <option value="p247">Star</option>
                        <option value="p268">Aura</option>
                        <option value="p294">Juniper</option>
                        <option value="p306">Breeze</option>
                        <option value="p308">Nova</option>
                        <option value="p316">Echo</option>
                      </optgroup>
                      <!-- Male Voices -->
                      <optgroup label="Male Voices">
                        <option value="p230">Cove</option>
                        <option value="p233">Sol</option>
                        <option value="p251">Spruce</option>
                        <option value="p286">Arbor</option>
                        <option value="p287">Ash</option>
                        <option value="p302">Slate</option>
                        <option value="p307">Drift</option>
                        <option value="p312">River</option>
                        <option value="p317">Orion</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="whisperTtsSpeedRange" class="form-label"
                      >Playback Speed</label
                    >
                    <input
                      type="range"
                      class="form-range"
                      id="whisperTtsSpeedRange"
                      min="0.5"
                      max="2"
                      step="0.1"
                      value="1"
                    />
                    <div class="text-center">
                      <span id="whisperTtsSpeedValue">1.0x</span>
                    </div>
                  </div>
                  <hr />
                  <!-- Model TTS controls -->
                  <h6 class="fw-bold">Model TTS Settings</h6>
                  <div class="mb-3">
                    <label for="modelTtsSpeakerSelect" class="form-label"
                      >Voice</label
                    >
                    <select class="form-select" id="modelTtsSpeakerSelect">
                      <!-- Female Voices -->
                      <optgroup label="Female Voices">
                        <option value="p240">Dawn</option>
                        <option value="p244">Ember</option>
                        <option value="p245">Willow</option>
                        <option value="p246">Rose</option>
                        <option value="p247">Star</option>
                        <option value="p268">Aura</option>
                        <option value="p294">Juniper</option>
                        <option value="p306">Breeze</option>
                        <option value="p308">Nova</option>
                        <option value="p316">Echo</option>
                      </optgroup>
                      <!-- Male Voices -->
                      <optgroup label="Male Voices">
                        <option value="p230">Cove</option>
                        <option value="p233">Sol</option>
                        <option value="p251">Spruce</option>
                        <option value="p286">Arbor</option>
                        <option value="p287">Ash</option>
                        <option value="p302">Slate</option>
                        <option value="p307">Drift</option>
                        <option value="p312">River</option>
                        <option value="p317">Orion</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="modelTtsSpeedRange" class="form-label"
                      >Playback Speed</label
                    >
                    <input
                      type="range"
                      class="form-range"
                      id="modelTtsSpeedRange"
                      min="0.5"
                      max="2"
                      step="0.1"
                      value="1"
                    />
                    <div class="text-center">
                      <span id="modelTtsSpeedValue">1.0x</span>
                    </div>
                  </div>
                </div>
                <!-- card-body -->
              </div>
            </div>
          </div>
        </div>
        <!-- end AUDIO CONTROLS TAB -->

        <!-- SERVER CONTROL TAB -->
        <div
          class="tab-pane fade"
          id="serverControl"
          role="tabpanel"
          aria-labelledby="server-tab"
        >
          <div class="row justify-content-center g-4 mt-3">
            <div class="col-md-8">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white text-center">
                  <h5 class="mb-0">Triton Server Control</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button id="start-server" class="btn btn-success">
                      Start Server
                    </button>
                    <button id="stop-server" class="btn btn-danger">
                      Stop Server
                    </button>
                    <button id="logs-server" class="btn btn-dark">
                      Get Triton Logs
                    </button>
                  </div>
                  <!-- Server result messages -->
                  <div id="server-result" class="mt-3" style="display: none">
                    <div class="alert alert-info" id="server-message"></div>
                  </div>
                  <!-- Triton logs box -->
                  <div
                    id="server-logs-box"
                    class="logs-box mt-3"
                    style="display: none"
                  ></div>
                </div>
                <!-- card-body -->
              </div>
            </div>
          </div>
        </div>
        <!-- /serverControl tab -->
      </div>
      <!-- /tab-content -->
    </div>
    <!-- /container -->

    <!-- Footer -->
    <footer>
      <small>&copy; 2025 - LLM Playground (Single Page)</small>
    </footer>

    <!-- JS: jQuery + Bootstrap Bundle + Our scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /********************************************
       *       GLOBAL STATE + HELPER FUNCS        *
       ********************************************/
      let currentActivityId = null;
      let activityRecords = []; // All records in this activity
      let currentRecordIndex = -1; // Which record is being displayed

      let mediaRecorder;
      let audioChunks = [];
      let recordInterval;
      let recordStartTime;

      // Format time helper
      function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) {
          return "00:00";
        }
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return (
          String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0")
        );
      }

      /********************************************
       *         ON DOCUMENT READY               *
       ********************************************/
      $(document).ready(function () {
        // Always start a new activity on page load
        createNewActivity();

        // SHIFT+ENTER => new line, ENTER => submit in #query
        $("#query").keydown(function (e) {
          if (e.keyCode === 13 && !e.shiftKey) {
            e.preventDefault();
            $("#submitQueryBtn").click();
          }
        });
        // SHIFT+ENTER => new line, ENTER => submit in #whisper-transcription-editable
        $("#whisper-transcription-editable").keydown(function (e) {
          if (e.keyCode === 13 && !e.shiftKey) {
            e.preventDefault();
            $("#whisperInferenceBtn").click();
          }
        });

        // Load model list
        loadModelsForDropdown("#model");
        loadModelsForDropdown("#delete_model_name");
        loadModelsForDropdown("#code_model_name");

        // Refresh => new activity
        $("#refreshActivityBtn").click(function () {
          createNewActivity();
        });

        // Load => fetch existing activity by ID
        $("#loadActivityBtn").click(function () {
          const inputId = $("#loadActivityInput").val().trim();
          if (!inputId) return;
          currentActivityId = inputId;
          $("#currentActivityLabel").text(currentActivityId);
          fetchActivityRecords(); // fetch & display from DB
        });

        // Back/Next buttons
        $("#backBtn").click(function () {
          if (activityRecords.length === 0) return;
          if (currentRecordIndex > 0) {
            currentRecordIndex--;
            displayRecord(activityRecords[currentRecordIndex]);
          }
        });
        $("#nextBtn").click(function () {
          if (activityRecords.length === 0) return;
          if (currentRecordIndex < activityRecords.length - 1) {
            currentRecordIndex++;
            displayRecord(activityRecords[currentRecordIndex]);
          }
        });

        // Submit user query
        $("#submitQueryBtn").click(function () {
          submitTextQuery();
        });

        // Submit whisper text for inference
        $("#whisperInferenceBtn").click(function () {
          const input_text = $("#whisper-transcription-editable").val().trim();
          const model = $("#model").val();
          if (!model) {
            alert("Please select a model first.");
            return;
          }
          if (!input_text) {
            alert("No text to infer. Please transcribe or type something.");
            return;
          }
          resetModelTtsUI();
          resetWhisperTtsUI();

          $("#loader").show();
          $("#response-container").hide();

          $.post(
            "/api/query",
            {
              model: model,
              query: input_text,
              activity_id: currentActivityId
            },
            function (data) {
              $("#loader").hide();
              if (data.response) {
                // Fill the UI with the new model response
                $("#response").text(data.response);
                $("#response-container").show();
                $("#responseAudioSection").show(); // let user generate audio
                // Now refetch the entire activity so it's in our history
                fetchActivityRecords(true);
              } else {
                $("#response").text("Error: " + data.error);
                $("#response-container").show();
                $("#responseAudioSection").hide();
              }
            }
          ).fail(function (xhr) {
            $("#loader").hide();
            $("#response").text(
              "Error: " + (xhr.responseJSON?.error || xhr.statusText)
            );
            $("#response-container").show();
            $("#responseAudioSection").hide();
          });
        });

        // Start recording (mic)
        $("#startRecordingBtn").click(async function () {
          // Hide old sections
          $("#response-container").hide();
          $("#responseAudioSection").hide();
          $("#whisper-container").hide();
          $("#whisperAudioSection").hide();
          $("#whisperInferenceSection").hide();

          audioChunks = [];
          resetModelTtsUI();
          resetWhisperTtsUI();

          // Determine a mimeType that is supported
          let mimeType = "";
          const possibleTypes = [
            "audio/webm; codecs=opus",
            "audio/mp4",
          ];
          for (const t of possibleTypes) {
            if (MediaRecorder.isTypeSupported(t)) {
              mimeType = t;
              break;
            }
          }
          // If none found, let the browser pick
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true
            });

            if (mimeType) {
              mediaRecorder = new MediaRecorder(stream, { mimeType });
            } else {
              mediaRecorder = new MediaRecorder(stream);
            }

            mediaRecorder.onstart = function () {
              $("#recordingUI").removeClass("hidden");
              $("#recordingIndicator").show();
              startRecordingTimer();
            };
            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                audioChunks.push(e.data);
              }
            };
            mediaRecorder.start();
          } catch (err) {
            $("#recordingUI").addClass("hidden");
            $("#response").text(
              "Error: Unable to start recording. " + err.message
            );
            $("#response-container").show();
            $("#responseAudioSection").hide();
            resetRecordingUI();
          }
        });

        // Cancel recording
        $("#cancelRecordingBtn").click(function () {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
          stopRecordingTimer();
          $("#recordingIndicator").hide();
          resetRecordingUI();
        });

        // Confirm => send to /api/transcribe
        $("#confirmRecordingBtn").click(function () {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
          mediaRecorder.onstop = async () => {
            $("#loader").show();
            stopRecordingTimer();
            $("#recordingIndicator").hide();
            $("#recordingUI").addClass("hidden");

            // We'll decide extension based on what we used
            // If we used "audio/mp4" => name it "recording.mp4"
            // else => default "recording.webm"
            let extension = ".webm";
            if (mediaRecorder.mimeType.indexOf("mp4") !== -1) {
              extension = ".mp4";
            }

            const blob = new Blob(audioChunks, {
              type: mediaRecorder.mimeType || "audio/webm"
            });
            const formData = new FormData();
            formData.append("audio_data", blob, "recording" + extension);
            formData.append("activity_id", currentActivityId);

            $.ajax({
              url: "/api/transcribe",
              method: "POST",
              data: formData,
              processData: false,
              contentType: false,
              success: function (data) {
                $("#loader").hide();
                if (data.transcription) {
                  // Show the new transcription
                  $("#whisper-transcription-editable").val(data.transcription);
                  $("#whisper-container").show();
                  $("#whisperAudioSection").show();
                  $("#whisperInferenceSection").show();
                } else if (data.error) {
                  $("#response").text("Error: " + data.error);
                  $("#response-container").show();
                  $("#responseAudioSection").hide();
                }
                resetRecordingUI();
                // fetch updates so this new step is in our activityRecords
                fetchActivityRecords(true);
              },
              error: function (xhr) {
                $("#loader").hide();
                $("#response").text(
                  "Error: " + (xhr.responseJSON?.error || xhr.statusText)
                );
                $("#response-container").show();
                $("#responseAudioSection").hide();
                resetRecordingUI();
              },
            });
          };
        });

        // Initialize TTS control logic
        initTTSControls();
      });

      /********************************************
       *        CREATE / LOAD / FETCH ACTIVITY    *
       ********************************************/
      function createNewActivity() {
        $.get("/api/new_activity", function (data) {
          currentActivityId = data.activity_id;
          $("#currentActivityLabel").text(currentActivityId);
          activityRecords = [];
          currentRecordIndex = -1;
        });
      }

      function loadModelsForDropdown(selector) {
        $.get("/api/list_models", function (data) {
          const sel = $(selector);
          sel.empty();
          sel.append(`<option value="" disabled selected>Select a model</option>`);
          if (data.models && data.models.length) {
            data.models.forEach((m) => {
              sel.append(`<option value="${m}">${m}</option>`);
            });
          }
        });
      }

      // Pull from DB so we can do back/next
      function fetchActivityRecords(goToLast = false) {
        if (!currentActivityId) return;
        $.get("/api/get_activity?activity_id=" + currentActivityId, (data) => {
          if (data.records) {
            activityRecords = data.records;
            if (activityRecords.length) {
              if (goToLast) {
                currentRecordIndex = activityRecords.length - 1;
              } else {
                if (currentRecordIndex < 0) {
                  currentRecordIndex = 0;
                }
              }
              displayRecord(activityRecords[currentRecordIndex]);
            }
          }
        });
      }

      /********************************************
       *         DISPLAY / NAVIGATE RECORDS       *
       ********************************************/
      function displayRecord(record) {
        // Clear TTS UIs
        resetModelTtsUI();
        resetWhisperTtsUI();

        const type = record.interaction_type;

        if (type === "text-to-text") {
          $("#query").val(record.input_data || "");
          $("#response").text(record.output_data || "");
          $("#response-container").show();

          // Show "Generate Audio" button if there's something to speak
          if (record.output_data && record.output_data.trim()) {
            $("#responseAudioSection").show();
          } else {
            $("#responseAudioSection").hide();
          }

          // Hide whisper parts
          $("#whisper-container").hide();
          $("#whisperAudioSection").hide();
          $("#whisperInferenceSection").hide();

        } else if (type === "speech-to-text") {
          $("#whisper-transcription-editable").val(record.output_data || "");
          $("#whisper-container").show();
          $("#whisperAudioSection").show();
          $("#whisperInferenceSection").show();

          // Hide normal response
          $("#response-container").hide();
          $("#responseAudioSection").hide();

        } else if (type === "text-to-speech") {
          // Typically we do not directly display text-to-speech records here
          $("#response-container").hide();
          $("#responseAudioSection").hide();
          $("#whisper-container").hide();
          $("#whisperAudioSection").hide();
          $("#whisperInferenceSection").hide();
        }
      }

      /********************************************
       *             SUBMIT USER QUERY            *
       ********************************************/
      function submitTextQuery() {
        const model = $("#model").val();
        const input_text = $("#query").val().trim();
        if (!model) {
          alert("Please select a model first.");
          return;
        }
        if (!input_text) {
          alert("No text provided.");
          return;
        }
        resetModelTtsUI();
        resetWhisperTtsUI();

        $("#loader").show();
        $("#response-container").hide();
        $("#responseAudioSection").hide();

        $.post("/api/query",
          {
            model: model,
            query: input_text,
            activity_id: currentActivityId
          },
          function (data) {
            $("#loader").hide();
            if (data.response) {
              $("#response").text(data.response);
              $("#response-container").show();
              $("#responseAudioSection").show();
              fetchActivityRecords(true);
            } else {
              $("#response").text("Error: " + data.error);
              $("#response-container").show();
              $("#responseAudioSection").hide();
            }
          }
        ).fail(function (xhr) {
          $("#loader").hide();
          $("#response").text(
            "Error: " + (xhr.responseJSON?.error || xhr.statusText)
          );
          $("#response-container").show();
          $("#responseAudioSection").hide();
        });
      }

      /********************************************
       *              RECORDING TIMER             *
       ********************************************/
      function startRecordingTimer() {
        recordStartTime = Date.now();
        recordInterval = setInterval(function () {
          const elapsedMs = Date.now() - recordStartTime;
          const totalSeconds = Math.floor(elapsedMs / 1000);
          $("#record-timer").text(formatTime(totalSeconds));
        }, 1000);
      }
      function stopRecordingTimer() {
        clearInterval(recordInterval);
        $("#record-timer").text("00:00");
      }
      function resetRecordingUI() {
        $("#recordingUI").addClass("hidden");
        $("#recordingIndicator").hide();
      }

      /********************************************
       *         TEXT-TO-SPEECH CONTROLS          *
       ********************************************/
      function initTTSControls() {
        // Model TTS
        const responseAudio = document.getElementById("responseAudio");
        const responseAudioControls = document.getElementById("responseAudioControls");
        const responsePlayPauseBtn = document.getElementById("responsePlayPauseBtn");
        const responseAudioProgress = document.getElementById("responseAudioProgress");
        const responseAudioTime = document.getElementById("responseAudioTime");

        $("#playResponseTTSBtn").click(function () {
          resetModelTtsUI();
          const text = $("#response").text().trim();
          if (!text) return;
          const speaker = $("#modelTtsSpeakerSelect").val();
          const speed = $("#modelTtsSpeedRange").val();

          $.post(
            "/api/tts",
            {
              text: text,
              speaker: speaker,
              speed: speed,
              activity_id: currentActivityId
            },
            function (data) {
              if (data.audio) {
                responseAudioControls.style.display = "flex";
                responseAudio.style.display = "none";
                responseAudio.src = "data:audio/wav;base64," + data.audio;
                responseAudio.load();
                responsePlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                responseAudioProgress.value = 0;
                responseAudioTime.textContent = "00:00 / 00:00";
              }
            }
          ).fail(function (xhr) {
            alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
          });
        });

        responsePlayPauseBtn.addEventListener("click", function () {
          if (responseAudio.paused || responseAudio.currentTime <= 0) {
            responseAudio.play();
            responsePlayPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
          } else {
            responseAudio.pause();
            responsePlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
          }
        });

        responseAudio.addEventListener("timeupdate", function () {
          if (responseAudio.duration > 0) {
            const percent = (responseAudio.currentTime / responseAudio.duration) * 100;
            responseAudioProgress.value = percent;
          }
          const cur = formatTime(responseAudio.currentTime);
          const dur = formatTime(responseAudio.duration);
          responseAudioTime.textContent = `${cur} / ${dur}`;
        });

        responseAudioProgress.addEventListener("input", function () {
          if (responseAudio.duration) {
            responseAudio.currentTime =
              (responseAudioProgress.value / 100) * responseAudio.duration;
          }
        });

        responseAudio.addEventListener("ended", function () {
          responsePlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        });

        // Whisper TTS
        const whisperAudio = document.getElementById("whisperAudio");
        const whisperAudioControls = document.getElementById("whisperAudioControls");
        const whisperPlayPauseBtn = document.getElementById("whisperPlayPauseBtn");
        const whisperAudioProgress = document.getElementById("whisperAudioProgress");
        const whisperAudioTime = document.getElementById("whisperAudioTime");

        $("#playWhisperTTSBtn").click(function () {
          resetWhisperTtsUI();
          const text = $("#whisper-transcription-editable").val().trim();
          if (!text) return;
          const speaker = $("#whisperTtsSpeakerSelect").val();
          const speed = $("#whisperTtsSpeedRange").val();

          $.post(
            "/api/tts",
            {
              text: text,
              speaker: speaker,
              speed: speed,
              activity_id: currentActivityId
            },
            function (data) {
              if (data.audio) {
                whisperAudioControls.style.display = "flex";
                whisperAudio.classList.remove("hidden");
                whisperAudio.src = "data:audio/wav;base64," + data.audio;
                whisperAudio.load();
                whisperPlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                whisperAudioProgress.value = 0;
                whisperAudioTime.textContent = "00:00 / 00:00";
              }
            }
          ).fail(function (xhr) {
            alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
          });
        });

        whisperPlayPauseBtn.addEventListener("click", function () {
          if (whisperAudio.paused || whisperAudio.currentTime <= 0) {
            whisperAudio.play();
            whisperPlayPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
          } else {
            whisperAudio.pause();
            whisperPlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
          }
        });

        whisperAudio.addEventListener("timeupdate", function () {
          if (whisperAudio.duration > 0) {
            const percent = (whisperAudio.currentTime / whisperAudio.duration) * 100;
            whisperAudioProgress.value = percent;
          }
          const cur = formatTime(whisperAudio.currentTime);
          const dur = formatTime(whisperAudio.duration);
          whisperAudioTime.textContent = `${cur} / ${dur}`;
        });

        whisperAudioProgress.addEventListener("input", function () {
          if (whisperAudio.duration) {
            whisperAudio.currentTime =
              (whisperAudioProgress.value / 100) * whisperAudio.duration;
          }
        });

        whisperAudio.addEventListener("ended", function () {
          whisperPlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        });
      }

      function resetModelTtsUI() {
        const responseAudio = document.getElementById("responseAudio");
        const responseAudioControls = document.getElementById("responseAudioControls");
        const responseAudioProgress = document.getElementById("responseAudioProgress");
        const responseAudioTime = document.getElementById("responseAudioTime");
        const responsePlayPauseBtn = document.getElementById("responsePlayPauseBtn");
        responseAudio.pause();
        responseAudio.src = "";
        responseAudioTime.textContent = "00:00 / 00:00";
        responseAudioProgress.value = 0;
        responseAudioControls.style.display = "none";
        responsePlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
      }

      function resetWhisperTtsUI() {
        const whisperAudio = document.getElementById("whisperAudio");
        const whisperAudioControls = document.getElementById("whisperAudioControls");
        const whisperAudioProgress = document.getElementById("whisperAudioProgress");
        const whisperAudioTime = document.getElementById("whisperAudioTime");
        const whisperPlayPauseBtn = document.getElementById("whisperPlayPauseBtn");
        whisperAudio.pause();
        whisperAudio.src = "";
        whisperAudioTime.textContent = "00:00 / 00:00";
        whisperAudioProgress.value = 0;
        whisperAudioControls.style.display = "none";
        whisperAudio.classList.add("hidden");
        whisperPlayPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
      }

      /********************************************
       *          MANAGE MODELS & SERVER          *
       ********************************************/
      // Add Model
      $("#add-model-form").on("submit", function (e) {
        e.preventDefault();
        $("#add-model-result").hide();
        $("#usage-code").hide();
        $.post("/api/add_model", $(this).serialize(), function (data) {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            $("#add-model-success").text(data.message);
            $("#add-model-result").show();
            $("#usage-code").text(data.usage_code).show();
            loadModelsForDropdown("#model");
            loadModelsForDropdown("#delete_model_name");
            loadModelsForDropdown("#code_model_name");
          }
        }).fail(function (xhr) {
          alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
        });
      });

      // Delete Model
      $("#delete-model-form").on("submit", function (e) {
        e.preventDefault();
        $("#delete-model-result").hide();
        $.post("/api/delete_model", $(this).serialize(), function (data) {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            $("#delete-model-success").text(data.message);
            $("#delete-model-result").show();
            loadModelsForDropdown("#model");
            loadModelsForDropdown("#delete_model_name");
            loadModelsForDropdown("#code_model_name");
          }
        }).fail(function (xhr) {
          alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
        });
      });

      // Get Client Code
      $("#get-code-form").on("submit", function (e) {
        e.preventDefault();
        $("#get-code-result").hide();
        $.post("/api/get_client_code", $(this).serialize(), function (data) {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            $("#client-code-display").text(data.usage_code);
            $("#get-code-result").show();
          }
        }).fail(function (xhr) {
          alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
        });
      });

      // Server Start
      $("#start-server").click(function () {
        $("#server-result").hide();
        $("#server-logs-box").hide();
        $.post("/api/start_server", {}, function (data) {
          if (data.error) {
            $("#server-message").text(data.error);
            if (data.logs) {
              $("#server-logs-box").text(data.logs).show();
            }
            $("#server-result").show();
          } else {
            $("#server-message").text(data.message);
            $("#server-result").show();
          }
        }).fail(function (xhr) {
          alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
        });
      });

      // Server Stop
      $("#stop-server").click(function () {
        $("#server-result").hide();
        $("#server-logs-box").hide();
        $.post("/api/stop_server", {}, function (data) {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            $("#server-message").text(data.message);
            $("#server-result").show();
          }
        }).fail(function (xhr) {
          alert("Error: " + (xhr.responseJSON?.error || xhr.statusText));
        });
      });

      // Server Logs
      $("#logs-server").click(function () {
        $("#server-result").hide();
        $.get("/api/get_server_logs", function (data) {
          if (data.logs) {
            $("#server-logs-box").text(data.logs).show();
          } else {
            $("#server-logs-box").text("No logs available.").show();
          }
        }).fail(function (xhr) {
          const errMsg =
            xhr.responseJSON?.error ||
            xhr.statusText ||
            "Error retrieving logs";
          $("#server-logs-box").text(errMsg).show();
        });
      });
    </script>
  </body>
</html>